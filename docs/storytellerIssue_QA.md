# Storyteller Layout & Sequencing Fix (QA Documentation)

## Issue Overview
**Date:** 2026-02-23
**Symptom:** Sequential stories in the 'Creative Storyteller' mode were experiencing layout breakage. Titles appeared out of order, images for the second story would overwrite the first, and narrative text would sometimes render before the title.

## Root Cause Analysis
The issue was tracked down to a combination of **network latency** and **unreliable metadata** in the Gemini Live API stream:

1.  **Missing `invocationId`:** The grouping logic in `CreativeStudio.tsx` relied on the `invocationId` field to delineate "turns" (packets of information belonging to one AI response). However, the Gemini Live payload does not always include this ID for all parts (e.g., streaming text chunks or tool calls). When `undefined`, the grouping logic merged every item from the entire session into a single "giant turn."
2.  **Strict Type Sorting across stories:** Because all items were in one giant turn, the type-based sorting logic (`Title > Image > Text`) clustered all titles together at the top of the feed and all images together, effectively destroying the chronological separation between Story 1 and Story 2.
3.  **Race Conditions:** Text streaming occasionally arrived a fraction of a millisecond before the title tool call (`begin_story`), causing text to float at the top of the feed.

## Resolution Steps

### 1. Robust Client-Side Turn Management
Modified `useGeminiCore.ts` to implement a deterministic "Turn Tracker":
-   Introduced `currentTurnIdRef` which holds a unique UUID generated by the client.
-   This ID is manually injected into every incoming artifact (Transcript, Tool Call, Audio Event).
-   The ID is strictly cycled (refreshed with a new UUID) only when:
    -   The model emits `turnComplete: true`.
    -   A "Barge-in" interruption is detected.
-   **Result:** Even if the API doesn't provide an ID, the frontend now mathematically guarantees information separation between model "beats."

### 2. Logical Rank Sorting within Turns
Updated `CreativeStudio.tsx` (the stream renderer) to use balanced sorting:
-   **First Pass:** Items are grouped by the new reliable `invocationId`.
-   **Second Pass:** Each group is sorted by a strict internal hierarchy:
    1.  `story_segment` (Titles)
    2.  `audio_event` / `rule_event`
    3.  `image`
    4.  `text` (Narration)
-   **Result:** Even if a text pixel arrives before a title tool call, React will hold the text below the title and image in the DOM, ensuring a consistent "Storybook" layout.

### 3. Story Indexing
Refactored `groupItems` to assign a stable `storyIndex` during the rendering pass based purely on the count of `story_segment` objects encountered chronologically.

## Verification
-   [x] Generate Story 1: Title, Image, and 3 paragraphs appear in Box 1.
-   [x] End Story 1: Director prompt appears below narration.
-   [x] Generate Story 2: Box 2 is created below Box 1 with new Title and Image.
-   [x] No "bleeding" of text or images between unique story IDs.
-   [x] Interruptions correctly reset the turn ID to prevent partial text from merging with a fresh story attempt.
